#!/bin/env python

from ScarScript import ScarScript

class lsjobs(ScarScript):
  """
  Parse pbsnodes output to report the users and jobs running on each batch node.

  lsjobs [-h -v] [--property=str] [pattern ...]

  This script prints userid/jobid pairs for each batch job running on a
  specified set of nodes, or "FREE" if no jobs are assigned.  Options:

    -h
      Show this information, then exit

    -v
      Print version, then exit

    --property=str
      Report only those nodes that have the specified property.

    pattern
      Report only those nodes whose names match one of the listed patterns.
      By default, all nodes are reported.
  """

  VERSION = 1.0

  def __init__(self):
    (options, args) = self.parseArgs(['--property:s'])
    self.property = None
    if options.property:
      self.property = options.property
    if len(args) == 0:
      args.append('.')
    for pat in args:
      nodeJobs = self.getNodeJobs(pat, self.property)
      nodes = nodeJobs.keys()
      nodes.sort()
      for node in nodes:
        jobs = nodeJobs[node]
        if len(jobs) > 0:
          free = ''
          if int(jobs[len(jobs) - 1]) > 0:
            free = " FREEx%s" % jobs[len(jobs) - 1]
          print '%s:%s%s' % (node, ' '.join(jobs[0:len(jobs) - 1]), free)

lsjobs()
