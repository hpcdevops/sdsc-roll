version: 2
jobs:
  "build-centos6":
    docker:
      - image: hpcdevops/docker-centos6-rocksbuilder
    working_directory: ~/${CIRCLE_PROJECT_REPONAME}
    steps:
      - checkout
      - run:
          shell: /bin/bash -l
          command: |
            echo "Changing direcotry to ${CIRCLE_WORKING_DIRECTORY}..."
            cd ${CIRCLE_WORKING_DIRECTORY}
            echo "Currently in $(pwd)..."
            echo "Non-CIRCLE Environment is..."
            printenv | grep -v CIRCLE | sort
            echo "Starting bootstrap and build..."
            ROLL_TO_BUILD=$(awk '/ROLLNAME/ {print $3}' version.mk)
            echo "=-=-=- Build of ${ROLL_TO_BUILD}-roll started at $(date) -=-=-="
            if [ -f ./bootstrap.sh ] ; then
              grep -q yum ./bootstrap.sh && sed -i 's/sudo yum/yum/g;s/yum/sudo yum -y/g;' ./bootstrap.sh
              chmod +x ./bootstrap.sh
              ./bootstrap.sh
              sudo make clean && sudo rm ${PWD}/_arch
            fi
            make default
            for f in $(find . -name "*.iso") ; do
              echo -e "=-=-=- Roll ISO $f Details =-=-=-\n"
              ls -l $f
              echo ""
              isoinfo -R -f -i $f
            done
            cd ${CIRCLE_WORKING_DIRECTORY}
            echo "=-=-=- Build of ${ROLL_TO_BUILD}-roll required "$(du -s --block-size=1k ${BUILD_DIR} | awk '{printf "%'\''d KB\n", $1}')" -=-=-="
            cd ${CIRCLE_WORKING_DIRECTORY}
            tar -cf - $(find . -name "*.iso") | ( cd $HOME; tar -xvf - )
            cd ${HOME}
            ls -ltr
            echo "=-=-=- Build of ${ROLL_TO_BUILD}-roll finished at $(date) -=-=-="

  "build-centos7":
    docker:
      - image: hpcdevops/docker-centos7-rocksbuilder
    working_directory: ~/${CIRCLE_PROJECT_REPONAME}
    steps:
      - checkout
      - run:
          shell: /bin/bash -l
          command: |
            echo "Changing direcotry to ${CIRCLE_WORKING_DIRECTORY}..."
            cd ${CIRCLE_WORKING_DIRECTORY}
            echo "Currently in $(pwd)..."
            echo "Non-CIRCLE Environment is..."
            printenv | grep -v CIRCLE | sort
            echo "Starting bootstrap and build..."
            ROLL_TO_BUILD=$(awk '/ROLLNAME/ {print $3}' version.mk)
            echo "=-=-=- Build of ${ROLL_TO_BUILD}-roll started at $(date) -=-=-="
            if [ -f ./bootstrap.sh ] ; then
              grep -q yum ./bootstrap.sh && sed -i 's/sudo yum/yum/g;s/yum/sudo yum -y/g;' ./bootstrap.sh
              chmod +x ./bootstrap.sh
              ./bootstrap.sh
              sudo make clean && sudo rm ${PWD}/_arch
            fi
            make default
            for f in $(find . -name "*.iso") ; do
              echo -e "=-=-=- Roll ISO $f Details =-=-=-\n"
              ls -l $f
              echo ""
              isoinfo -R -f -i $f
            done
            cd ${CIRCLE_WORKING_DIRECTORY}
            echo "=-=-=- Build of ${ROLL_TO_BUILD}-roll required "$(du -s --block-size=1k ${BUILD_DIR} | awk '{printf "%'\''d KB\n", $1}')" -=-=-="
            cd ${CIRCLE_WORKING_DIRECTORY}
            tar -cf - $(find . -name "*.iso") | ( cd $HOME; tar -xvf - )
            cd ${HOME}
            ls -ltr
            echo "=-=-=- Build of ${ROLL_TO_BUILD}-roll finished at $(date) -=-=-="

workflows:
  version: 2
  build:
    jobs:
      - "build-centos6"
      - "build-centos7"
